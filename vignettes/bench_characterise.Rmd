---
title: "Characterise time series"
author: "Wanda De Keersmaecker"
date: ""
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Characterise time series}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
#eval = FALSE prevents code chunks to be run
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```


```{r, include=FALSE}
# source_rmd <- function(file, local = FALSE, ...){
#   options(knitr.duplicate.label = 'allow')
#   
#   tempR <- tempfile(tmpdir = ".", fileext = ".R")
#   on.exit(unlink(tempR))
#   knitr::purl(file, output=tempR, quiet = TRUE)
#   
#   envir <- globalenv()
#   source(tempR, local = envir, ...)
# }
```

# Characterize dynamics of Landsat time series components
This script decomposes time series into a set of components (trend, remainder, and seasonality) and characterizes each of these components

## 1. Import libraries and source functions

```{r}
library(bfast)
library(forecast)
source('../R/fun_general.R')
source('../R/fun_simulate.R')

```

## 2. Inputs

The following inputs are required:

* _ifolder_: path to the folder where the input file (i.e file containing the time series to be characterised) is stored
* _ofolder_: path to the folder where the time series characteristics need to be stored
* _basename_: name of the input file (i.e file containing the time series to be characterised)
* _nyr_: number of years of the input time series
* _nobsYr_: number of observations per year of the input time series


```{r}
ifolder <- '../Data/'#'C:\\Users\\keers001\\Data\\RETURN\\20191019_SimulationOptSAR\\Landsat\\SampledData\\'
ofolder <-'../Data/'#'C:\\Users\\keers001\\Data\\RETURN\\20191019_SimulationOptSAR\\Landsat\\Char\\'
basename <- 'toyset'#LSTS_RndmSample_NoFire_5_Tree_80_scl_30_npnt_20000_VI'
nyr <- 18 # number of years in observation period
nobsYr <- 365 # number of observations per year


```

## 3. Import data
Import the dataframe with time series that need to be characterized. The dataframe needs to be structured as follows:

* Each row represents a pixel
* The first two columns contain the coordinates of the pixel
* The remaining columns equal observations at a particular date. The dates must have regular intervals.

```{r}
ifileVI <- paste0(basename, '.rda')
dfVi <- loadRData(file = file.path(ifolder, ifileVI))
```

## 4. Decompose time series using BFAST01
Decomposition of time series into seasonality, trend and remainder

* Seasonality: modeled as a harmonic function
* Trend: linear trend without break
* Remainder: residuals, calculated as time series - trend * seasonality

```{r}
tmp <- decompTSbfast(dfVi, nyr, nobsYr)
#print(tmp)
# sesonality (fitted harmonic function)
dataVISeasbf <-  tmp[[1]]
# remainder
dataVIRembf <- tmp[[2]]
# trend (linear trend without break)
dataVITrbf <- tmp[[3]]
# coefficients of fitted harmonic functions 
dataVISeasCoef <- tmp[[4]]
```
## 5. Characterize each of the components
The following characteristics are derived from the decomposed time series:

* fraction of missing values
* seasonal amplitude (one value for input each time series)
* average seasonal pattern
* offset 
* standard deviation of the remainder component (one value per input time series)
* fitted ARMA model in the remainder component (one model per input time series)
```{r}
# ------------------------------------------------
# general

# fraction missing values
tsVIMissVal <- rowSums(is.na(dfVi))/dim(dfVi)[2]

# ------------------------------------------------
# seasonality

# seasonal amplitude for each pixel
seasVImax <- apply(dataVISeasbf[,-c(1,2)], 1, max) 
#average seasonal pattern
seasS <- dataVISeasbf[dataVISeasbf[,1]<0,]# only southern hemisphere to avoid interference of seasonal cycles
seasVImean <- colMeans(as.matrix(seasS[,-c(1,2)]))

# ------------------------------------------------
# offset 
TrVImean <- mean(rowMeans(as.matrix(dataVITrbf[,-c(1,2)])), na.rm=T)

# ------------------------------------------------
# remainder

# SD of remainder per pixel
Rem_VIsd <- apply(dataVIRembf[,-c(1,2)], 1, sd, na.rm=T)
# ARMA model - characterization of the remainder dynamics per pixel
Rem_VIcoef <- list()
for(i in 1:dim(dataVIRembf)[1]){
  Rem_VIcoef[[i]] <- getARMAcoef(ts(as.numeric(dataVIRembf[i,-c(1,2)]), frequency=nobsYr))
}

```
## 6. Export
 
```{r}
# create output folder if it does not already exist
if (! file.exists(ofolder)){
    dir.create(ofolder)
}

# Components
save(dataVISeasbf, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_Seasbf.rda')))
save(dataVIRembf, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_Rembf.rda')))
save(dataVITrbf, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_Trbf.rda')))
save(dataVISeasCoef, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_SeasCoefbf.rda')))

# characteristics components
save(seasVImax, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_seasVImax.rda')))
save(seasVImean, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_seasVImean.rda')))

save(TrVImean, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_TrVImean.rda')))

save(Rem_VIsd, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_Rem_VIsd.rda')))

save(Rem_VIcoef, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_Rem_VIcoef.rda')))
save(tsVIMissVal, file = file.path(ofolder, paste0(tools::file_path_sans_ext(ifileVI), '_ts_VIMissVal.rda')))
```

## 7. Plot data characteristics
```{r}
# Decomposition
library(zoo)

op <- par()
dev.off()
# Example time series
datz <- as.numeric(dfVi[10,-c(1,2)])
tmz <- as.Date(names(dfVi)[-c(1,2)])
tsz <- zoo(datz[is.na(datz)==F],tmz[is.na(datz)==F])
plot(tsz, type = 'o', main = 'Example sampled NBR time series',
     xlab = 'Time [year]', ylab = 'NBR [-]', lwd = 2)

# Example decomposition time series
remz <- as.numeric(dataVIRembf[10,-c(1,2)])
tsrz <- zoo(remz[is.na(remz)==F],tmz[is.na(remz)==F])
par(mar=c(2,2,2,1))
par(fig=c(0,1,0.66,1))
plot(tsz, type = 'o', main = 'Example NBR time series and trend',
     xlab = '', ylab = 'NBR [-]', lwd = 2)
lines(zoo(as.numeric(dataVITrbf[10,-c(1,2)]),tmz), col = 'red')
par(fig=c(0,1,0.33,0.66), new=TRUE)
plot(zoo(as.numeric(dataVISeasbf[10,-c(1,2)]),tmz), type = 'l', main = 'Seasonal',
     xlab = '', ylab = 'NBR [-]', lwd = 2)
par(fig=c(0,1,0,0.33), new=TRUE)
plot(tsrz, type = 'o', main = 'Remainder',
     xlab = 'Time [year]', ylab = 'NBR [-]', lwd = 2)

# all seasonal cycles 
par(op)
plot(zoo(t(dataVISeasbf[,-c(1,2)]),tmz), plot.type = "single", col = 'gray' , main = 'Seasonal sampled pixels',
     xlab = 'Time', ylab = 'NBR [-]')

# seasonal cylce Southern hemisphere and mean seasonal cycle
plot(zoo(t(dataVISeasbf[which(dataVISeasbf[,1]<0),-c(1,2)]),tmz), plot.type = "single", col = 'gray' , main = 'Seasonal Southern hemisphere and mean seasonal',
     xlab = 'Time', ylab = 'NBR [-]')
lines(as.Date(names(seasVImean)), seasVImean, type = 'l', lwd = 2)


# Amplitude seasonality
hist(seasVImax, main = 'Amplitude seasonality', xlab = 'Amplitude [-]')
mx <- mean(seasVImax)
abline(v = mx, col = "red", lwd = 2)


# missing values
hist(tsVIMissVal, main = 'Fraction missing values (daily temporal resolution)', xlab = 'Fraction missing values [-]')
mx <- mean(tsVIMissVal)
abline(v = mx, col = "red", lwd = 2)

# standard deviation remainder
hist(Rem_VIsd, main = 'Standard deviation remainder', xlab = 'Standard deviation remainder [-]')
mx <- mean(Rem_VIsd)
abline(v = mx, col = "red", lwd = 2)


# 
```

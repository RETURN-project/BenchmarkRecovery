---
title: "Create simulation settings file"
author: "Wanda De Keersmaecker"
date: ""
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Create simulation settings file}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```


```{r, include=FALSE}
# source_rmd <- function(file, local = FALSE, ...){
#   options(knitr.duplicate.label = 'allow')
#   
#   tempR <- tempfile(tmpdir = ".", fileext = ".R")
#   on.exit(unlink(tempR))
#   knitr::purl(file, output=tempR, quiet = TRUE)
#   
#   envir <- globalenv()
#   source(tempR, local = envir, ...)
# }
```

# Create simulation settings file 
*This scripts creates a settings file that is needed as input to simulate time series*

*In order to simulate the time series, each of the time series components (seasonality, offset, remainder, and disturbance) are seperately simulated and subsequently summed. To ensure that the characteristics of these components are realistically simulated, the simulation is based on the characteristics of components of sampled time series (these can be characterised using eg the bench_characterise script).*

*The __seasonality__ is represented by an average sampled seasonal pattern having zero mean. Its amplitude can be adjusted and set within the range of the observed seasonal amplitudes. Additionally, drought events can be introduced by setting the seasonal cycle of a particular year to its minimum value. The __offset__ equals the average value of the observed time series. The __remainder__ represents the anomaly (in case no major disturbances are present). This component is defined by an ARMA model, fitted in the sampled remainder components, and its standard deviation can be adjusted. Finally, the __disturbance__ is represented by a step function with linear recovery. Here, the disturbance magnitude (magnitude of step function), disturbance timing (timing of step function) and recovery period (time needed to return to the predisturbance value) can be adjusted. After summing each of the components, missing values are introduced, with a user defined fraction.*

*In summary, the following characteristics can be evaluated:*

* *seasonal amplitude*
* *number of droughts*
* *standard deviation of the remainder*
* *disturbance magnitude*
* *disturbance timing*
* *recovery period*
* *fraction of missing values*
* *number of observations*

*To be able to isolate the effect of a particular time series characteristic on the performance of a method, the following simulation set-up is used. First, a set of values are defined for each characteristic that needs to be evaluated. Second, for each value of the characteristic that is being evaluated, time series are generated that cover all combinations of values of the other characteristics. To that end, n time series are simulated per combination of all other characteristics (= repetitions).*

*To ensure that the time series components and values of time series characteristics are realistic, the following data need to be derived and provided from sampled time series:*

 - *Average seasonal pattern*
 - *Set of seasonal amplitudes from sampled time series*
 - *Offset*
 - *Standard deviation of remainder from sampled time series*
 - *fraction of missing values*
 - *ARMA model coeffients of the remainder term*
 
## Inputs
 
*The script requires the following inputs:*
    
* __ifolder__: input folder, directory of the sampled time series characteristics files
* __ofolder__: output folder, directory where the processed files will be stored
* __nfolder__: notebook folder, directory where the jupyter notebook files are stored
* __basename__: base name of the simulated time series files

```{r}
ifolder <- '../Data/' #'C:\\Users\\keers001\\OneDrive\ -\ WageningenUR\\RETURN\\Data\\RETURN\\20191019_SimulationOptSAR\\Landsat\\Char\\'  # folder with data characteristics
ofolder <- '../Data/' #C:\\Users\\keers001\\OneDrive\ -\ WageningenUR\\RETURN\\Data\\RETURN\\20191019_SimulationOptSAR\\Landsat\\Test_TSrequired\\TS_10\\SimTS\\'  # folder where the simulated time series will be saved

basename <- 'toyset'#c('LSTS_RndmSample_NoFire_5_Tree_80_scl_30_npnt_20000_VI')# base name of the data files

```

## Import data and source functions

* seasmax: half of the seasonal amplitude per pixel
* seasmean: mean seasonal pattern
* trmean: offset
* remsd: standard deviation of remainder
* remcoef: ARMA model coefficients of remainder term
* missval: fraction of missing values
```{r}
print(getwd())
source( '../R/fun_general.R')
source( '../R/fun_simulate.R')

seasmax <- loadRData(file = file.path(ifolder, paste0(basename, '_seasVImax.rda')))# half seasonal amplitude
seasmean <- loadRData(file = file.path(ifolder, paste0(basename, '_seasVImean.rda')))
trmean <- loadRData(file = file.path(ifolder, paste0(basename, '_TrVImean.rda')))
remsd <- loadRData(file = file.path(ifolder, paste0(basename, '_Rem_VIsd.rda')))
remcoef <- loadRData(file = file.path(ifolder, paste0(basename, '_Rem_VIcoef.rda')))
missval <- loadRData(file = file.path(ifolder, paste0(basename, '_ts_VIMissVal.rda')))
```

## Define simulation settings 
*Here, the simulation settings are defined:*

* __STnrep__: number of time series simulated per combination of all settings
* __STnobsYr__: number of observations simulated per year (this should equal the frequency of the sampled time series)
* __DistMissVal__: defines how the introduced missing values should be distributed: random or at an equal interval
* __STseasAv__: represents the seasonal pattern
* __STtrAv__: offset
* __VnDr__: number of droughts simulated
* __Vnyr__: time series length (number of years)
* __VdistMag__: disturbance magnitude, should be a negative value to simulate a drop
* __VdistT__: timing disturbance (disturbance year)
* __VdistRec__: recovery half time after disturbance (number of observations)
* __VmissVal__: fraction of missing values in time series
* __VseasAmp__: <- seasonal amplitude
* __VremSd__: standard deviation of the remainder


```{r}
  #-------------------------------------------------
  #  settings  
STnrep <- 1 # number of repetitions per parameter combination
STnobsYr <- 365
DistMissVal <- 'random' # random or interval
STseasAv <- seasmean
STtrAv <- trmean # offset

VnDr <- c(0) # number of droughts
Vnyr <- c(16,20)#seq(6,40,6)# number of years
VdistMag <- -c(0.1,0.5)#-seq(0.1,0.5,0.1)# magnitude disturbance
VdistT <- c(5,10) #seq(3,18,3)# timing disturbance
VdistRec <- c(1.5,5)*STnobsYr#seq(3,15,2)*STnobsYr# recovery disturbance
Vqntl <- c(.05, .95)#c(.05, .275, .5, .725, .95)# set of quantiles used to derive realistic values (for number of missing values, seasonal amplitude and standard deviation of the remainder) from sampled data
VmissVal <- quantile(missval, Vqntl)
VseasAmp <- quantile(seasmax, Vqntl)# seasonal amplitude
VremSd <- quantile(remsd, Vqntl)# sd of remainder
VdistType <- 'piecewise'
  
```
## Create settings list
All settings are combined in a list, this settings list can be used to simulate time series
```{r}
sttngs <- list(STnrep,
              Vnyr,
              STnobsYr,
              VnDr, 
              STseasAv, 
              VseasAmp,
              STtrAv,
              VremSd,
              VdistMag,
              VdistT, 
              VdistRec, 
              VmissVal, 
              DistMissVal, 
              remcoef,
              VdistType,
              c( 'nyr',  
                  'seasAmp',
                  'remSd', 
                  'distMag',
                  'distT', 
                  'distRec', 
                  'missVal'))
names(sttngs) <- c('nrep',
                  'nyr',
                  'nobsYr',
                  'nDr', 
                  'seasAv', 
                  'seasAmp',
                  'trAv', 
                  'remSd', 
                  'distMag',
                  'distT', 
                  'distRec', 
                  'missVal', 
                  'DistMissVal',
                  'remcoef',
                  'distType',
                  'variables')


```
## Export

```{r}
save(sttngs, file = file.path(ofolder, paste0(basename, '_simTS_settings_var.rda')))
  
```
